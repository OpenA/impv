#!/usr/bin/env python

import sys
import os
import socket
import subprocess

# constants
_MPV_ = (os.getenv('MPV') or 'mpv')
_PORT = '/tmp/impv-socket'

# variables
sock  = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
opts  = [_MPV_]
files = []

# flags
APPEND_TO_LIST = False
SHOW_BLANK_UI  = False

# parsing arguments
for arg in (sys.argv[1:]):
    if arg[:2] == '--':
        if arg == '--blank':
            SHOW_BLANK_UI = True
        elif arg == '--add-playlist':
            APPEND_TO_LIST = True
        else:
            opts.append(arg)
    else: # make them absolute
        files.append(arg)

try:
    sock.connect(_PORT)
    files_string = '", "'.join(files)

    #IS_MPV_RUNNING = (
    #    # check if ipc server active
    #    subprocess.check_output('echo \'{ "command": ["get_property", "volume"] }\' | socat - '+_PORT, shell=True) != ''
    #)

    if APPEND_TO_LIST:
        files_string += '", "append'

    sock.sendall('{ "command": ["loadfile", "'+files_string+'"] }\n')
    sock.sendall('{ "command": ["set_property", "pause", false] }\n')

except socket.error:

    if SHOW_BLANK_UI:
        opts.extend(['--player-operation-mode=pseudo-gui', '--force-window'])

    opts.extend(['--input-ipc-server='+_PORT, '--autofit-smaller=640x480', '--autofit-larger=100%x100%'])
    opts.extend(files)

    subprocess.check_call(opts)

finally:
    sock.close()
